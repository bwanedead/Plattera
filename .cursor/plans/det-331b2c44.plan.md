<!-- 331b2c44-411c-4b89-9c03-52005b3f3e7a df7e29f8-af0c-48cf-ae25-d948184e3965 -->
# Deterministic Resolver Refactor (Frontend)

## Goals

- Always display the exact version the user selects (no implicit fallbacks).
- Make switching instant and race-proof (no freezes, no stale updates).
- Preserve current UX for run/segment/dossier clicks (policy only when no version is specified).

## Scope (Frontend only)

- Keep backend and on-disk storage as-is.
- Update resolver, add versioning utility + index, add cancellation + minimal logging.

## Design

- Exact-ID first: If `path.draftId` is present, fetch that exact `versionedId` (v1/v2/Av1/Av2/consensus). No fallback to “best”. If 404, show a clear error state.
- Two-stage resolve:
1) ComputeFetchPlan (pure): given `DossierPath` + loaded dossier, compute `{versionedId, transcriptionId, context}` synchronously using a prebuilt index.
2) Execute plan (impure): fetch content for `versionedId` with cancellation and caching.
- Version Index: Build `Map<versionedId, {transcriptionId, baseDraftId, context}>` at dossier load/refresh time (or lazily on first resolve) and cache it per dossierId. Invalidate on `dossiers:refresh`/`dossier:refreshOne`.
- Race-proofing: Each view request carries a `requestId`; only the latest response is applied. Optionally use AbortController in `textApi`.
- Viewer remains “dumb”: renders content it’s given; no policy logic.

## Files to Change

- frontend/src/services/dossier/selectionResolver.ts
- frontend/src/services/dossier/versioning.ts (new)
- frontend/src/components/image-processing/ResultsViewer.tsx
- frontend/src/services/textApi.ts (optional: AbortController)

## Implementation Steps

1) Add `versioning.ts` utility

- Parse/build versioned IDs (raw, align, consensus).
- `buildVersionIndex(dossier)` to produce O(1) lookup from versionedId → {transcriptionId, baseDraftId, context}.
- Lightweight in-module cache keyed by dossierId; invalidate on refresh events.

2) Refactor resolver

- Add `computeFetchPlan(dossier, path)` that:
- If `path.draftId` provided: resolve via index; if not found but `run` exists, return a plan with `versionedId = path.draftId` and the run’s `transcriptionId`.
- If no `draftId`: apply existing run/segment/dossier policies but convert to a concrete `versionedId` using HEAD info from metadata.
- `resolveSelectionToText` executes the plan, fetches the text once for that `versionedId`, returns `{mode:'draft', text, context}`.
- Remove implicit fallbacks that return unrelated content when a specific draftId is provided.

3) Race-proof ResultsViewer view requests

- Wrap `onViewRequest` with a `requestId` guard (ignore stale responses). Optionally store an AbortController per request.
- Log a concise confirmation when a view is applied (requested id, chars length).

4) Optional: Abortable textApi

- Add optional `signal?: AbortSignal` to `getDraftJson/getDraftText`, pass it from ResultsViewer so in-flight HTTP can be cancelled on quick switches.

5) Metrics & Logging (temporary, dev only)

- Log once per view: `{requestedDraftId, transcriptionId, displayedChars}`.
- Log a single warning if a requested id 404s.

## Non-Goals

- Changing how files are stored on disk.
- Changing editor/heatmap behavior beyond ensuring the correct selected version is displayed.

## Backward Compatibility

- Run/segment/dossier clicks behave as today, but are resolved to a concrete versionedId (HEAD) before loading.
- No API contract changes.

## Acceptance Criteria

- Clicking any version pill (v1/v2/Av1/Av2/consensus v1/v2) shows the exact corresponding content every time.
- Rapidly switching versions never shows stale content; only the latest selection is applied.
- No fallback to unrelated drafts on 404; show a clear error toast/inline message.
- Switching is near-instant on subsequent clicks due to index and cache.

## Testing

- Manual: Switch across raw v1/v2, alignment Av1/Av2, consensus v1/v2 for multiple drafts; verify recognizable strings.
- Race: Click different version pills rapidly; confirm only last click applies.
- Error: Temporarily rename a versioned file to simulate 404; confirm error UI, no fallback content.

### To-dos

- [ ] Create versioning.ts (parse/build IDs, buildVersionIndex, cache, invalidation)
- [ ] Implement computeFetchPlan and exact-id fetch path in selectionResolver.ts
- [ ] Guard ResultsViewer onViewRequest with requestId (and optional AbortController)
- [ ] Add optional AbortSignal to textApi fetches and wire through
- [ ] Add concise logs on apply and a single warning on 404, dev-only
- [ ] Run manual tests for raw/align/consensus, race, and 404 cases